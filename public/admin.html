<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  
  <title>C&L Global Admin page</title>
  <style>
    @media (max-width: 600px) {
      body {
        padding: 1rem;
      }
      .logout-btn {
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.4rem 0.8rem;
      }
      .login-box, form {
        width: 100%;
      }
      input, textarea {
        font-size: 0.95rem;
      }
      .notice {
        padding: 0.8rem;
      }
    }
  </style>
  
  <style>
    body {
      font-family: sans-serif;
      max-width: 1800px;
      margin: 0 auto;
      padding: 1rem;
      background: #f8f9fa;
    }
    h1 {
      color: #002244;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 2rem;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input, textarea {
      padding: 0.5rem;
      font-size: 1rem;
      width: 98%;
    }
    button {
      padding: 0.6rem;
      background: #002244;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #004488;
    }
    .notice {
      background: #fff;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 4px solid #002244;
      border-radius: 6px;
    }
    .notice-actions {
      margin-top: 0.5rem;
    }
    .notice-actions button {
      margin-right: 0.5rem;
    }

    .logout-btn {
  padding: 0.6rem 1rem;
  background-color: white;
  color: #002244;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: background 0.3s ease;
  margin-top: 0.5rem;
}


  .logout-btn:hover {
    background-color: #004488;
  }
  

  #content-ko,
#content-en,
#content-zh {
  height: 350px; /* ì›í•˜ëŠ” ë†’ì´(px)ë¡œ ì¡°ì •í•˜ì„¸ìš” */
  resize: vertical; /* ì‚¬ìš©ìê°€ ìˆ˜ì§ìœ¼ë¡œ ì¡°ì ˆí•  ìˆ˜ ìˆê²Œ í—ˆìš© (ì„ íƒì‚¬í•­) */
}

  </style>

<style>
    .tabs {
      display: flex;
      margin-bottom: 1rem;
    }
    .tab-btn {
      flex: 1;
      padding: 0.6rem;
      cursor: pointer;
      background: #e0e0e0;
      border: none;
      font-weight: bold;
    }
    .tab-btn.active {
      background: #002244;
      color: white;
    }
    .tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}


.lang-btn-filter {
  padding: 0.4rem 1rem;
  background: #e0e0e0;
  border: none;
  font-weight: 600;
  cursor: pointer;
  border-radius: 4px;
}
.lang-btn-filter.active {
  background: #002244;
  color: white;
}

.notice-detail .content a {
  color: #0055aa;
  font-weight: 500;
  text-decoration: underline;
  word-break: break-all;
}

.admin-tabs-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(90deg, #002244, #004488);
  padding: 1rem 1.5rem;
  border-radius: 12px;
  margin-bottom: 2rem;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  flex-wrap: wrap;
}

.admin-tabs {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.admin-tab {
  color: white;
  font-weight: 600;
  padding: 0.6rem 1.4rem;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  text-decoration: none;
  transition: background 0.3s ease, transform 0.2s ease;
}

.admin-tab:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: translateY(-2px);
}

.admin-tab.active {
  background: white;
  color: #002244;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.logout-btn {
  padding: 0.6rem 1rem;
  background-color: white;
  color: #002244;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: background 0.3s ease;
  margin-top: 0.5rem;
}

.logout-btn:hover {
  background-color: #dde4ee;
}

#pagination button {
  margin: 0 4px;
  padding: 0.5rem 0.9rem;
  border: none;
  background: #e0e0e0;
  color: #002244;
  font-weight: 600;
  cursor: pointer;
  border-radius: 6px;
  transition: background 0.3s ease;
}

#pagination button:hover {
  background: #cfd8dc;
}

#pagination button.active {
  background: #002244;
  color: white;
}

.main-layout {
  display: flex;
  gap: 2rem;
  align-items: flex-start;
}

#notice-form {
  flex: 1.5;
  min-width: 400px;
}

.preview-panel {
  flex: 1;
  min-width: 300px;
}

#notice-list {
  max-height: 600px;
  overflow-y: auto;
}

    </style>
</head>

<body>
      
    <header class="admin-tabs-container">
              <div style="display: flex; align-items: center; gap: 2rem;">
    <a href="index.html">
      <img src="images/logo.png" alt="C&L Global ë¡œê³ " style="height: 40px;" />
    </a>
        <nav class="admin-tabs">
          <a href="admin.html" class="admin-tab active">ê³µì§€ì‚¬í•­ ê´€ë¦¬</a>
          <a href="admin-newsletter.html" class="admin-tab">ë‰´ìŠ¤ë ˆí„° ê´€ë¦¬</a>
          <a href="admin-resources.html" class="admin-tab">ìë£Œì‹¤ ê´€ë¦¬</a>
        </nav>
        <button class="logout-btn" id="logout-btn" style="margin-left: 1000px;">ë¡œê·¸ì•„ì›ƒ</button>
      </header>
      
      

      
      
  <h1>ê³µì§€ì‚¬í•­ ê´€ë¦¬</h1>
  
<div class="main-layout">

      <div class="preview-panel">
    <div id="language-tabs" style="margin: 1rem 0; display: flex; gap: 1rem;">
      <button type="button" class="lang-btn-filter active" data-lang="ko">í•œêµ­ì–´</button>
      <button type="button" class="lang-btn-filter" data-lang="en">English</button>
      <button type="button" class="lang-btn-filter" data-lang="zh">ä¸­æ–‡</button>
    </div>


  <section id="notice-list"></section>
  <div id="pagination" style="text-align: center; margin: 2rem 0;"></div>
</div>



  <form id="notice-form">
    <input type="hidden" id="notice-id">
  
    <div class="tabs">
      <button type="button" class="tab-btn active" data-tab="ko">í•œêµ­ì–´</button>      
      <button type="button" class="tab-btn" data-tab="en">English</button>
      <button type="button" class="tab-btn" data-tab="zh">ä¸­æ–‡</button>
    </div>



    <div class="tab-content active" id="tab-ko">
      <input id="title-ko" name="title-ko" placeholder="ì œëª© (í•œê¸€)" />
      <textarea id="content-ko" placeholder="ë‚´ìš© (í•œê¸€)"></textarea>
    </div>

    <div class="tab-content" id="tab-en">
      <input id="title-en" name="title-en" placeholder="Title (English)" />
      <textarea id="content-en" placeholder="Content (English)"></textarea>
    </div>  
  
    <div class="tab-content" id="tab-zh">
      <input id="title-zh" name="title-zh" placeholder="æ ‡é¢˜ (ì¤‘êµ­ì–´)" />
      <textarea id="content-zh" placeholder="å†…å®¹ (ì¤‘êµ­ì–´)"></textarea>
    </div>

  <button type="button" onclick="insertHyperlink()" style="margin-top: 0.5rem; width: 150px;">ğŸ”— ë§í¬ ì‚½ì…</button>

    <input type="file" id="file-upload" multiple />
    <div id="preview" style="margin-top: 1rem;"></div>
  
    <button type="submit">ì €ì¥</button>
  </form>
  </div>


  <script>
const uploadInput = document.getElementById('file-upload');
const previewArea = document.getElementById('preview');
    const contentField = document.getElementById('content-ko');
    const uploadedImages = [];

  
    // ë¡œê·¸ì¸ ê²€ì‚¬
const token = sessionStorage.getItem('token');
if (!token) {
  alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  window.location.href = '/admin-login.html';
}

  
    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      localStorage.removeItem('token');
      alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      window.location.href = '/admin-login.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('logout-btn').addEventListener('click', () => {
sessionStorage.removeItem('token');

    alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    window.location.href = '/admin-login.html';
  });
});

  
    // ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadNotices(q = "") {
      const res = await fetch('/api/notices?q=' + encodeURIComponent(q));
      const data = await res.json();
      const notices = data.notices || [];         // âœ… ì¶”ê°€
      const list = document.getElementById('notice-list');
      list.innerHTML = "";
      const lang = selectedLang || 'ko'; // ğŸ”¥ ì„ íƒëœ íƒ­ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©


notices.forEach(notice => {
    const title = notice.title?.[lang] || notice.title?.en || notice.title?.ko || notice.title?.zh || '(ì œëª© ì—†ìŒ)';
const content = notice.content?.[lang] || notice.content?.en || notice.content?.ko || notice.title?.zh || '';

const titleEl = document.createElement("strong");
titleEl.textContent = title;

const timeEl = document.createElement("small");
timeEl.textContent = new Date(notice.createdAt).toLocaleString();

const contentEl = document.createElement("p");
contentEl.textContent = content;

const actionsDiv = document.createElement("div");
actionsDiv.className = "notice-actions";

const editBtn = document.createElement("button");
editBtn.textContent = "âœ ìˆ˜ì •";
editBtn.addEventListener("click", () => editNotice(notice));

const deleteBtn = document.createElement("button");
deleteBtn.textContent = "ğŸ—‘ ì‚­ì œ";
deleteBtn.addEventListener("click", () => deleteNotice(notice._id));

actionsDiv.appendChild(editBtn);
actionsDiv.appendChild(deleteBtn);

const div = document.createElement("div");
div.className = "notice";
div.appendChild(titleEl);
div.appendChild(timeEl);
div.appendChild(contentEl);
div.appendChild(actionsDiv);

list.appendChild(div);

});

    }
  
    const searchInput = document.getElementById('search');
if (searchInput) {
  searchInput.addEventListener('input', () => {
    const q = searchInput.value;
    loadNotices(q);
  });
}

  
    // ê¸€ ìˆ˜ì •
    function editNotice(notice) {
      document.getElementById('notice-id').value = notice._id;
      document.getElementById('title-ko').value = notice.title.ko;
      document.getElementById('title-en').value = notice.title.en;
      document.getElementById('title-zh').value = notice.title.zh;
      document.getElementById('content-ko').value = notice.content.ko;
      document.getElementById('content-en').value = notice.content.en;
      document.getElementById('content-zh').value = notice.content.zh;
    }
  
    // ê¸€ ì‚­ì œ
    async function deleteNotice(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await fetch(`/api/notices/${id}`, { method: 'DELETE' });
      loadNotices();
    }
  
  
  // Drag & Drop
  previewArea.ondragover = (e) => {
    e.preventDefault();
    previewArea.style.border = '2px dashed #004488';
  };
  previewArea.ondragleave = (e) => {
    e.preventDefault();
    previewArea.style.border = '';
  };
  previewArea.ondrop = (e) => {
    e.preventDefault();
    previewArea.style.border = '';
    uploadInput.files = e.dataTransfer.files;
    uploadInput.dispatchEvent(new Event('change'));
  };

  // ì´ë¯¸ì§€ ì—…ë¡œë“œ + ì‚­ì œ ë²„íŠ¼ + ë³¸ë¬¸ ì‚½ì…
uploadInput.addEventListener('change', async (e) => {
  const files = Array.from(e.target.files);
  const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
  const textarea = document.getElementById(`content-${activeTab}`);

  for (const file of files) {
    const formData = new FormData();
    formData.append('image', file);

    const res = await fetch('/api/notices/upload', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + sessionStorage.getItem('token')
      },
      body: formData
    });

    const data = await res.json();
    const fileUrl = data.url;
    const ext = file.name.split('.').pop().toLowerCase();

    let insertTag = '';
    if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
      insertTag = `<img src="${fileUrl}" alt="ì²¨ë¶€ ì´ë¯¸ì§€">\n`;
    } else {
      insertTag = `<a href="${fileUrl}" download>${file.name}</a>\n`;
    }

    textarea.value += `\n${insertTag}`;

    // â¬‡ï¸ ë¯¸ë¦¬ë³´ê¸° + ì‚­ì œ ë²„íŠ¼ ìƒì„±
    const wrapper = document.createElement('div');
    wrapper.style.marginBottom = '0.5rem';
    wrapper.style.position = 'relative';

    let previewElement;
    if (insertTag.includes('<img')) {
      previewElement = document.createElement('img');
      previewElement.src = fileUrl;
      previewElement.width = 100;
      previewElement.style.borderRadius = '6px';
      previewElement.style.boxShadow = '0 1px 4px rgba(0,0,0,0.1)';
    } else {
      previewElement = document.createElement('a');
      previewElement.href = fileUrl;
      previewElement.textContent = file.name;
      previewElement.style.color = '#0055aa';
      previewElement.download = '';
    }

    // ì‚­ì œ ë²„íŠ¼
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'ì‚­ì œ';
    deleteBtn.style.marginLeft = '1rem';
    deleteBtn.style.background = '#ff5555';
    deleteBtn.style.color = 'white';
    deleteBtn.style.border = 'none';
    deleteBtn.style.padding = '0.3rem 0.6rem';
    deleteBtn.style.borderRadius = '4px';
    deleteBtn.style.cursor = 'pointer';

    // ì‚­ì œ ë™ì‘: ë¯¸ë¦¬ë³´ê¸° ì œê±° + textarea ë‚´ìš©ì—ì„œë„ ì‚­ì œ
    deleteBtn.addEventListener('click', () => {
      previewArea.removeChild(wrapper);
      textarea.value = textarea.value.replace(insertTag.trim(), '').trim();
    });

    wrapper.appendChild(previewElement);
    wrapper.appendChild(deleteBtn);
    previewArea.appendChild(wrapper);
  }
});


  
    // í˜ì´ì§€ ë¡œë“œì‹œ ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸°
    loadNotices();


// ì €ì¥ì‹œ ì–¸ì–´ë³„ ë‚´ìš© ë¹„ì–´ìˆìœ¼ë©´ null ì²˜ë¦¬
document.getElementById('notice-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const id = document.getElementById('notice-id').value;
  const langs = ['ko', 'en', 'zh'];
  let hasAtLeastOne = false;



  const currentTabLang = document.querySelector('.tab-btn.active').dataset.tab;

const titleInput = document.getElementById(`title-${currentTabLang}`);
const contentInput = document.getElementById(`content-${currentTabLang}`);

const title = titleInput?.value?.trim();
const content = contentInput?.value?.trim();

if (!title && !content) {
  alert("ì œëª© ë˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
  return;
}

const payload = {
  title: { [currentTabLang]: title },
  content: { [currentTabLang]: content },
  category: 'notice' // â† ë°˜ë“œì‹œ í¬í•¨
};



  const method = id ? 'PUT' : 'POST';
  const url = id ? `/api/notices/${id}` : '/api/notices';

  await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  document.getElementById('notice-form').reset();
  document.getElementById('notice-id').value = '';

  // âœ… ì²¨ë¶€íŒŒì¼ ì´ˆê¸°í™”
uploadInput.value = '';
previewArea.innerHTML = '';

  // âœ… ì €ì¥ëœ ì–¸ì–´ íƒ­ì„ ì„ íƒ ìƒíƒœë¡œ ë°˜ì˜
  selectedLang = currentTabLang;

  // íƒ­ ë²„íŠ¼ ì‹œê°ì ìœ¼ë¡œë„ í™œì„±í™” ì²˜ë¦¬
  document.querySelectorAll('.lang-btn-filter').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.lang === selectedLang);
  });

  // âœ… ì„ íƒ ì–¸ì–´ ê¸°ì¤€ìœ¼ë¡œ ê³µì§€ì‚¬í•­ ë‹¤ì‹œ ë Œë”ë§
  renderPostsFromServer(1);

  alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
});



let selectedLang = 'ko'; // âœ… ì´ˆê¸°ê°’: í•œêµ­ì–´
document.addEventListener("DOMContentLoaded", () => {
  renderPostsFromServer(1); // âœ… ê¸°ë³¸ ê³µì§€ì‚¬í•­ ë¡œë”©

  // âœ… ìƒë‹¨ íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const lang = btn.dataset.tab;
    switchLanguage(lang);
  });
});

// âœ… í•˜ë‹¨ ëª©ë¡ íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
document.querySelectorAll('.lang-btn-filter').forEach(btn => {
  btn.addEventListener('click', () => {
    const lang = btn.dataset.lang;
    switchLanguage(lang);
  });
});

});



function renderPostsFromServer(page = 1, query = "") {
  fetch('/api/notices?category=notice&q=' + encodeURIComponent(query))
    .then(res => res.json())
    .then(resData => {
      const allPosts = resData.notices || [];
      const lang = selectedLang || 'ko';

      // âœ… ì–¸ì–´ë³„ í•„í„°ë§ëœ ê²Œì‹œê¸€ë§Œ ë”°ë¡œ ë¶„ë¦¬
      const filtered = allPosts.filter(post =>
        post.title?.[lang] && post.content?.[lang]
      );

      const postsPerPage = 5;
      const start = (page - 1) * postsPerPage;
      const sliced = filtered.slice(start, start + postsPerPage);

      const listContainer = document.getElementById("notice-list");
      listContainer.innerHTML = "";

      sliced.forEach(post => {
        const title = post.title?.[lang];
        const content = post.content?.[lang];
        const div = document.createElement("div");
        div.className = "notice";
        div.innerHTML = `
          <strong>${title}</strong><br>
          <small>${new Date(post.createdAt).toLocaleString()}</small>
          <p>${content}</p>
          <div class="notice-actions">
            <button onclick='editNotice(${JSON.stringify(post)})'>âœ ìˆ˜ì •</button>
            <button onclick='deleteNotice("${post._id}")'>ğŸ—‘ ì‚­ì œ</button>
          </div>
        `;
        listContainer.appendChild(div);
      });

      // âœ… í˜ì´ì§€ë„¤ì´ì…˜ë„ ì‹¤ì œ í•„í„°ë§ëœ ê°œìˆ˜ ê¸°ì¤€
      renderPagination(filtered.length, page);
    });
}


function insertImageToActiveContent(url) {
  // í˜„ì¬ í™œì„± íƒ­ ì°¾ê¸°
  const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
  const textarea = document.getElementById(`content-${activeTab}`);
  const imgTag = `<img src="${url}" alt="ì²¨ë¶€ ì´ë¯¸ì§€">\n`;

  textarea.value += `\n${imgTag}`; // ê¸°ì¡´ ë‚´ìš© ë’¤ì— ì´ë¯¸ì§€ ì‚½ì…
}


function switchLanguage(lang) {
  // ğŸ”¹ ìƒë‹¨ ì…ë ¥ íƒ­ ë™ê¸°í™”
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === lang);
  });
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.toggle('active', tab.id === `tab-${lang}`);
  });

  // ğŸ”¹ í•˜ë‹¨ ë¯¸ë¦¬ë³´ê¸° íƒ­ ë™ê¸°í™”
  document.querySelectorAll('.lang-btn-filter').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.lang === lang);
  });

  // ğŸ”¹ ì „ì—­ ì–¸ì–´ ë³€ìˆ˜ ë³€ê²½ ë° ëª©ë¡ ë Œë”ë§
  selectedLang = lang;
  renderPostsFromServer(1);
}

function renderPagination(totalPosts, currentPage) {
  const totalPages = Math.ceil(totalPosts / 5); // í˜ì´ì§€ ìˆ˜ ê³„ì‚°
  const pagination = document.getElementById("pagination");

  if (!pagination) return; // pagination ìš”ì†Œê°€ ì—†ì„ ê²½ìš° ì˜ˆì™¸ ì²˜ë¦¬

  pagination.innerHTML = "";

  for (let i = 1; i <= totalPages; i++) {
    const button = document.createElement("button");
    button.textContent = i;
    if (i === currentPage) button.classList.add("active");
    button.addEventListener("click", () => renderPostsFromServer(i));
    pagination.appendChild(button);
  }
}


function insertHyperlink() {
  const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
  const textarea = document.getElementById(`content-${activeTab}`);

  const url = prompt("ë§í¬í•  ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: https://www.example.com)");
  if (!url) return;

  const text = prompt("ë§í¬ì— í‘œì‹œí•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", url);
  if (text === null) return;

  const linkTag = `<a href="${url}" target="_blank">${text}</a>`;
  textarea.value += `\n${linkTag}\n`;
}

  </script>
  
  


</body>
</html>
