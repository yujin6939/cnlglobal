<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- Toast UI Editor -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

  
  <title>C&L Global Admin page</title>
  <style>
    @media (max-width: 600px) {
      body {
        padding: 1rem;
      }
      .logout-btn {
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.4rem 0.8rem;
      }
      .login-box, form {
        width: 100%;
      }
      input, textarea {
        font-size: 0.95rem;
      }
      .notice {
        padding: 0.8rem;
      }
    }
  </style>
  
  <style>
    body {
      font-family: sans-serif;
      max-width: 1800px;
      margin: 2rem auto;
      padding: 1rem;
      background: #f8f9fa;
    }
    h1 {
      color: #002244;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 2rem;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input, textarea {
      padding: 0.5rem;
      font-size: 1rem;
      width: 98%;
    }
    button {
      padding: 0.6rem;
      background: #002244;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #004488;
    }
    .notice {
      background: #fff;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 4px solid #002244;
      border-radius: 6px;
    }
    .notice-actions {
      margin-top: 0.5rem;
    }
    .notice-actions button {
      margin-right: 0.5rem;
    }

    .logout-btn {
  padding: 0.6rem 1rem;
  background-color: white;
  color: #002244;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: background 0.3s ease;
  margin-top: 0.5rem;
}


  .logout-btn:hover {
    background-color: #004488;
  }
 
    #content-ko,
#content-en,
#content-zh {
  height: 350px; /* 원하는 높이(px)로 조정하세요 */
  resize: vertical; /* 사용자가 수직으로 조절할 수 있게 허용 (선택사항) */
}
  </style>

<style>
    .tabs {
      display: flex;
      margin-bottom: 1rem;
    }
    .tab-btn {
      flex: 1;
      padding: 0.6rem;
      cursor: pointer;
      background: #e0e0e0;
      border: none;
      font-weight: bold;
    }
    .tab-btn.active {
      background: #002244;
      color: white;
    }
    .tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}


.lang-btn-filter {
  padding: 0.4rem 1rem;
  background: #e0e0e0;
  border: none;
  font-weight: 600;
  cursor: pointer;
  border-radius: 4px;
}
.lang-btn-filter.active {
  background: #002244;
  color: white;
}

.notice-detail .content a {
  color: #0055aa;
  font-weight: 500;
  text-decoration: underline;
  word-break: break-all;
}

.admin-tabs-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(90deg, #002244, #004488);
  padding: 1rem 1.5rem;
  border-radius: 12px;
  margin-bottom: 2rem;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  flex-wrap: wrap;
}

.admin-tabs {
  display: flex;
  gap: 1rem;
  flex-wrap: nowrap; /* ✅ 줄바꿈 방지 */
  white-space: nowrap;     /* 내부 텍스트 줄바꿈 방지 */
}

.admin-tab {
  color: white;
  font-weight: 600;
  padding: 0.6rem 1.4rem;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  text-decoration: none;
  transition: background 0.3s ease, transform 0.2s ease;

  
    white-space: nowrap;     /* ✅ 텍스트 줄바꿈 방지 */
  flex-shrink: 0;          /* ✅ 버튼이 너무 작아지지 않도록 */
}

.admin-tab:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: translateY(-2px);
}

.admin-tab.active {
  background: white;
  color: #002244;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.logout-btn {
  padding: 0.6rem 1rem;
  background-color: white;
  color: #002244;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: background 0.3s ease;
  margin-top: 0.5rem;
      white-space: nowrap;  /* ✅ 줄바꿈 없이 한 줄 유지 */
  flex-shrink: 0;        /* ✅ 너무 작아지지 않도록 방지 */
}

.logout-btn:hover {
  background-color: #dde4ee;
}

.main-layout {
  display: flex;
  gap: 2rem;
  align-items: flex-start;
}

#notice-form {
  flex: 1.5;
  min-width: 400px;
}

.preview-panel {
  flex: 1;
  min-width: 300px;
}

#notice-list {
  max-height: 600px;
  overflow-y: auto;
}

.admin-header {
  display: flex;
  align-items: center;
  justify-content: space-between;  /* 🔥 왼쪽 로고~탭 / 오른쪽 로그아웃 버튼 구분 */
  flex-wrap: nowrap;
  gap: 1rem;
  width: 100%;
}

    </style>
</head>

<body>
      
    <header class="admin-tabs-container">
              <div class="admin-header" style="display: flex; align-items: center; gap: 2rem;">
    <a href="index.html">
      <img src="images/logo.png" alt="C&L Global 로고" style="height: 40px;" />
    </a>
        <nav class="admin-tabs">
          <a href="admin.html" class="admin-tab">Notice Management</a>
          <a href="admin-newsletter.html" class="admin-tab">Newsletter Management</a>
          <a href="admin-resources.html" class="admin-tab active">Resource Management</a>
        </nav>
        <button class="logout-btn" id="logout-btn">Sign out</button>
      </header>
      
      

      
      
  <h1>Resource Management</h1>


  <div class="main-layout">  
    
    <div class="preview-panel">
  <div id="language-tabs" style="margin: 1rem 0; display: flex; gap: 1rem;">
    <button type="button" class="lang-btn-filter active" data-lang="ko">한국어</button>
    <button type="button" class="lang-btn-filter" data-lang="en">English</button>
    <button type="button" class="lang-btn-filter" data-lang="zh">中文</button>
  </div>
  

  <section id="notice-list"></section>
  <div id="pagination" style="text-align:center; margin: 2rem 0;"></div>
    </div>
  <form id="notice-form">
    <input type="hidden" id="notice-id">

        <div style="color: gray;"><p>*If a post is written and saved in multiple languages simultaneously, deleting the post in one language will result in all three language versions being deleted. Please be cautious of this behavior.
</p></div>
  
    <div class="tabs">      
      <button type="button" class="tab-btn active" data-tab="ko">한국어</button>        
        <button type="button" class="tab-btn" data-tab="en">English</button>
      <button type="button" class="tab-btn" data-tab="zh">中文</button>
    </div>



<div class="tab-content active" id="tab-ko">
  <input id="title-ko" name="title-ko" placeholder="제목 (Korean)" />
  <div id="editor-ko"></div> <!-- textarea 대신 -->
</div>

<div class="tab-content" id="tab-en">
  <input id="title-en" name="title-en" placeholder="Title (English)" />
  <div id="editor-en"></div>
</div>

<div class="tab-content" id="tab-zh">
  <input id="title-zh" name="title-zh" placeholder="标题 (Chinese)" />
  <div id="editor-zh"></div>
</div>

  
    <input type="file" id="file-upload" multiple />
    <div id="preview" style="margin-top: 1rem;"></div>
  
    <button type="submit">Submit</button>
  </form>
  

</div>

  <script>
      const postsPerPage = 10;
const uploadInput = document.getElementById('file-upload');
const previewArea = document.getElementById('preview');
    const contentField = document.getElementById('content-ko');
    const uploadedImages = [];

  
    // 로그인 검사
const token = sessionStorage.getItem('token');
if (!token) {
  alert('Login is required.');
  window.location.href = '/admin-login.html';
}

  
    // 로그아웃
    function logout() {
      localStorage.removeItem('token');
      alert("You have been logged out.");
      window.location.href = '/admin-login.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('logout-btn').addEventListener('click', () => {
sessionStorage.removeItem('token');

    alert("You have been logged out.");
    window.location.href = '/admin-login.html';
  });
});

  
    // 공지사항 불러오기
    async function loadNotices(q = "") {
      const res = await fetch('/api/notices?q=' + encodeURIComponent(q));
      const data = await res.json();
      const notices = data.notices || [];         // ✅ 추가
      const list = document.getElementById('notice-list');
      list.innerHTML = "";
      const lang = localStorage.getItem('siteLanguage') || 'ko';

notices.forEach(notice => {
    const title = notice.title?.[lang] || notice.title?.en || notice.title?.ko || notice.title?.zh || '(Untitled)';
const content = notice.content?.[lang] || notice.content?.en || notice.content?.ko || notice.title?.zh || '';

const titleEl = document.createElement("strong");
titleEl.textContent = title;

const timeEl = document.createElement("small");
timeEl.textContent = new Date(notice.createdAt).toLocaleString();

const contentEl = document.createElement("p");
contentEl.textContent = content;

const actionsDiv = document.createElement("div");
actionsDiv.className = "notice-actions";

const editBtn = document.createElement("button");
editBtn.textContent = "✏ Edit";
editBtn.addEventListener("click", () => editNotice(notice));

const deleteBtn = document.createElement("button");
deleteBtn.textContent = "🗑 Delete";
deleteBtn.addEventListener("click", () => deleteNotice(notice._id));

actionsDiv.appendChild(editBtn);
actionsDiv.appendChild(deleteBtn);

const div = document.createElement("div");
div.className = "notice";
div.appendChild(titleEl);
div.appendChild(timeEl);
div.appendChild(contentEl);
div.appendChild(actionsDiv);

list.appendChild(div);

});

    }
  
    const searchInput = document.getElementById('search');
if (searchInput) {
  searchInput.addEventListener('input', () => {
    const q = searchInput.value;
    loadNotices(q);
  });
}

  
    // 글 수정
    function editNotice(notice) {
      document.getElementById('notice-id').value = notice._id;
      document.getElementById('title-ko').value = notice.title.ko;
      document.getElementById('title-en').value = notice.title.en;
      document.getElementById('title-zh').value = notice.title.zh;
      document.getElementById('content-ko').value = notice.content.ko;
      document.getElementById('content-en').value = notice.content.en;
      document.getElementById('content-zh').value = notice.content.zh;
    }
  
    // 글 삭제
    async function deleteNotice(id) {
      if (!confirm('Are you sure you want to delete this?')) return;
      await fetch(`/api/notices/${id}`, { method: 'DELETE' });
      loadNotices();
    }
  
  
  // Drag & Drop
  previewArea.ondragover = (e) => {
    e.preventDefault();
    previewArea.style.border = '2px dashed #004488';
  };
  previewArea.ondragleave = (e) => {
    e.preventDefault();
    previewArea.style.border = '';
  };
  previewArea.ondrop = (e) => {
    e.preventDefault();
    previewArea.style.border = '';
    uploadInput.files = e.dataTransfer.files;
    uploadInput.dispatchEvent(new Event('change'));
  };

  // 이미지 업로드 + 삭제 버튼 + 본문 삽입
uploadInput.addEventListener('change', async (e) => {
  const files = Array.from(e.target.files);
  const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
  const editor = editors[activeTab];

  files.forEach(async (file) => {
    const formData = new FormData();
    formData.append('image', file);

    const res = await fetch('/api/notices/upload', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + sessionStorage.getItem('token')
      },
      body: formData
    });

    const data = await res.json();
    const fileUrl = data.url;
    const ext = file.name.split('.').pop().toLowerCase();

    let insertTag = '';
    if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
      insertTag = `<img src="${fileUrl}" alt="첨부 이미지">\n`;
    } else if (['mp4', 'webm', 'ogg'].includes(ext)) {
      insertTag = `<video controls playsinline preload="metadata" style="max-width:100%; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.1);">
        <source src="${fileUrl}" type="video/${ext}">
        Your browser does not support the video tag.
      </video>\n`;
    } else {
insertTag = `<a href="${data.url}" download="${data.originalName}">${data.originalName}</a>\n`;


    }

    editor.insertText(insertTag);

    // 미리보기 UI 구성
    const wrapper = document.createElement('div');
    wrapper.style.marginBottom = '0.5rem';
    wrapper.style.position = 'relative';

    let previewElement;
    if (insertTag.includes('<img')) {
      previewElement = document.createElement('img');
      previewElement.src = fileUrl;
      previewElement.width = 100;
      previewElement.style.borderRadius = '6px';
    } else if (insertTag.includes('<video')) {
      previewElement = document.createElement('video');
      previewElement.src = fileUrl;
      previewElement.controls = true;
      previewElement.width = 180;
    } else {
      previewElement = document.createElement('a');
      previewElement.href = fileUrl;
      previewElement.textContent = file.name;
      previewElement.download = '';
    }

    // 삭제 버튼
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = '삭제';
    deleteBtn.style.marginLeft = '1rem';
    deleteBtn.style.background = '#ff5555';
    deleteBtn.style.color = 'white';
    deleteBtn.style.border = 'none';
    deleteBtn.style.padding = '0.3rem 0.6rem';
    deleteBtn.style.borderRadius = '4px';
    deleteBtn.style.cursor = 'pointer';

    deleteBtn.addEventListener('click', () => {
      previewArea.removeChild(wrapper);
      // 태그를 에디터에서 제거
      const html = editor.getHTML();
      editor.setHTML(html.replace(insertTag.trim(), '').trim());
    });

    wrapper.appendChild(previewElement);
    wrapper.appendChild(deleteBtn);
    previewArea.appendChild(wrapper);
  });
});

  
    // 페이지 로드시 공지사항 불러오기
    loadNotices();

    // 탭 전환
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');

        // 🔥 핵심: 선택된 언어로 갱신
        selectedLang = btn.dataset.tab;
    renderPostsFromServer(1); // 언어 바뀌었으니 리스트 다시 로딩
  });
});

// 저장시 언어별 내용 비어있으면 null 처리
document.getElementById('notice-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const id = document.getElementById('notice-id').value;
  const langs = ['ko', 'en', 'zh'];
  const title = {};
  const content = {};
  let hasAtLeastOne = false;

langs.forEach(lang => {
  const t = document.getElementById(`title-${lang}`).value.trim();
  const c = editors[lang].getHTML();  // HTML 값 가져오기
  if (t || c) hasAtLeastOne = true;
  title[lang] = t || null;
  content[lang] = c || null;
});


  if (!hasAtLeastOne) {
    alert("You must enter the title or content in at least one language.");
    return;
  }

  const currentPath = window.location.pathname;
  let category = 'notice';
  if (currentPath.includes('resources')) {
    category = 'resource';
  } else if (currentPath.includes('newsletter')) {
    category = 'newsletter';
  }

  const payload = {
    title,
    content,
    category
  };

  const method = id ? 'PUT' : 'POST';
  const url = id ? `/api/notices/${id}` : '/api/notices';

  await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  document.getElementById('notice-form').reset();
  document.getElementById('notice-id').value = '';
  uploadInput.value = '';
  previewArea.innerHTML = '';

    // 에디터 초기화 (HTML 비우기)
editors.ko.setHTML('');
editors.en.setHTML('');
editors.zh.setHTML('');

  renderPostsFromServer(1);
  alert("Saved successfully.");
});




let selectedLang = 'ko'; // ✅ 초기값: 한국어
document.addEventListener("DOMContentLoaded", () => {
  renderPostsFromServer(1); // ✅ 기본 공지사항 로딩
});


document.querySelectorAll('.lang-btn-filter').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.lang-btn-filter').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedLang = btn.dataset.lang;
    renderPostsFromServer(1); // 언어 변경 시 다시 로딩
  });
});

function renderPostsFromServer(page = 1, query = "") {
  fetch(`/api/notices?category=resource&page=${page}&q=${encodeURIComponent(query)}`)

    .then(res => res.json())
    .then(resData => {
  const allPosts = resData.notices || []; // ✅ 공지 배열 추출
  const start = (page - 1) * postsPerPage;
  const sliced = allPosts.slice(start, start + postsPerPage); // ✅ 이제 정상

      const listContainer = document.getElementById("notice-list");
      listContainer.innerHTML = "";

      sliced.forEach(post => {
        const title = post.title?.[selectedLang];
        const content = post.content?.[selectedLang];
        if (!title || !content) return;

        const div = document.createElement("div");
        div.className = "notice";
        div.innerHTML = `
          <strong>${title}</strong><br>
          <small>${new Date(post.createdAt).toLocaleString()}</small>
          <p>${content}</p>
          <div class="notice-actions">
            <button onclick='editNotice(${JSON.stringify(post)})'>✏ Edit</button>
            <button onclick='deleteNotice("${post._id}")'>🗑 Delete</button>
          </div>
        `;
        listContainer.appendChild(div);
      });

       renderPagination(allPosts.length, page);
    });
}

function insertImageToActiveContent(url) {
  // 현재 활성 탭 찾기
  const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
  const textarea = document.getElementById(`content-${activeTab}`);
  const imgTag = `<img src="${url}" alt="Attached Image">\n`;

  textarea.value += `\n${imgTag}`; // 기존 내용 뒤에 이미지 삽입
}

function renderPagination(totalPosts, currentPage) {
  const totalPages = Math.ceil(totalPosts / postsPerPage);
  const pagination = document.getElementById("pagination");

  if (!pagination) return;

  pagination.innerHTML = "";

  for (let i = 1; i <= totalPages; i++) {
    const button = document.createElement("button");
    button.textContent = i;
    if (i === currentPage) button.classList.add("active");
    button.addEventListener("click", () => renderPostsFromServer(i));
    pagination.appendChild(button);
  }
}

function switchLanguage(lang) {
  // 상단 탭
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === lang);
  });
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.toggle('active', tab.id === `tab-${lang}`);
  });

  // 하단 목록 탭
  document.querySelectorAll('.lang-btn-filter').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.lang === lang);
  });

  selectedLang = lang;
  renderPostsFromServer(1);
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchLanguage(btn.dataset.tab));
});

document.querySelectorAll('.lang-btn-filter').forEach(btn => {
  btn.addEventListener('click', () => switchLanguage(btn.dataset.lang));
});


function insertHyperlink() {
  const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
  const textarea = document.getElementById(`content-${activeTab}`);

  const url = prompt("Enter the URL to link to (https://www.example.com)");
  if (!url) return;

  const text = prompt("Enter the text to display for the link", url);
  if (text === null) return;

  const linkTag = `<a href="${url}" target="_blank">${text}</a>`;
  textarea.value += `\n${linkTag}\n`;
}

// 에디터 인스턴스 생성
const editors = {
  ko: new toastui.Editor({
    el: document.querySelector('#editor-ko'),
    height: '350px',
    initialEditType: 'wysiwyg',
    previewStyle: 'vertical',
    hooks: {
      async addImageBlobHook(blob, callback) {
        const formData = new FormData();
        formData.append('image', blob);

        const res = await fetch('/api/notices/upload', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('token') },
          body: formData
        });

        const data = await res.json();
        callback(data.url, '이미지');
      }
    }
  }),
  en: new toastui.Editor({
    el: document.querySelector('#editor-en'),
    height: '350px',
    initialEditType: 'wysiwyg',
    previewStyle: 'vertical',
    hooks: {
      async addImageBlobHook(blob, callback) {
        const formData = new FormData();
        formData.append('image', blob);

        const res = await fetch('/api/notices/upload', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('token') },
          body: formData
        });

        const data = await res.json();
        callback(data.url, 'image');
      }
    }
  }),
  zh: new toastui.Editor({
    el: document.querySelector('#editor-zh'),
    height: '350px',
    initialEditType: 'wysiwyg',
    previewStyle: 'vertical',
    hooks: {
      async addImageBlobHook(blob, callback) {
        const formData = new FormData();
        formData.append('image', blob);

        const res = await fetch('/api/notices/upload', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('token') },
          body: formData
        });

        const data = await res.json();
        callback(data.url, 'image');
      }
    }
  })
};

function editNotice(notice) {
  document.getElementById('notice-id').value = notice._id;
  document.getElementById('title-ko').value = notice.title.ko;
  document.getElementById('title-en').value = notice.title.en;
  document.getElementById('title-zh').value = notice.title.zh;

  editors.ko.setHTML(notice.content.ko || '');
  editors.en.setHTML(notice.content.en || '');
  editors.zh.setHTML(notice.content.zh || '');
}

 
  </script>
  
  


</body>
</html>
