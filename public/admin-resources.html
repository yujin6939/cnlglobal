<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  
  <title>C&L Global Admin page</title>
  <style>
    @media (max-width: 600px) {
      body {
        padding: 1rem;
      }
      .logout-btn {
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.4rem 0.8rem;
      }
      .login-box, form {
        width: 100%;
      }
      input, textarea {
        font-size: 0.95rem;
      }
      .notice {
        padding: 0.8rem;
      }
    }
  </style>
  
  <style>
    body {
      font-family: sans-serif;
      max-width: 1800px;
      margin: 2rem auto;
      padding: 1rem;
      background: #f8f9fa;
    }
    h1 {
      color: #002244;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 2rem;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input, textarea {
      padding: 0.5rem;
      font-size: 1rem;
      width: 98%;
    }
    button {
      padding: 0.6rem;
      background: #002244;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #004488;
    }
    .notice {
      background: #fff;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 4px solid #002244;
      border-radius: 6px;
    }
    .notice-actions {
      margin-top: 0.5rem;
    }
    .notice-actions button {
      margin-right: 0.5rem;
    }

    .logout-btn {
  padding: 0.6rem 1rem;
  background-color: white;
  color: #002244;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: background 0.3s ease;
  margin-top: 0.5rem;
}


  .logout-btn:hover {
    background-color: #004488;
  }
 
    #content-ko,
#content-en,
#content-zh {
  height: 350px; /* ì›í•˜ëŠ” ë†’ì´(px)ë¡œ ì¡°ì •í•˜ì„¸ìš” */
  resize: vertical; /* ì‚¬ìš©ìê°€ ìˆ˜ì§ìœ¼ë¡œ ì¡°ì ˆí•  ìˆ˜ ìˆê²Œ í—ˆìš© (ì„ íƒì‚¬í•­) */
}
  </style>

<style>
    .tabs {
      display: flex;
      margin-bottom: 1rem;
    }
    .tab-btn {
      flex: 1;
      padding: 0.6rem;
      cursor: pointer;
      background: #e0e0e0;
      border: none;
      font-weight: bold;
    }
    .tab-btn.active {
      background: #002244;
      color: white;
    }
    .tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}


.lang-btn-filter {
  padding: 0.4rem 1rem;
  background: #e0e0e0;
  border: none;
  font-weight: 600;
  cursor: pointer;
  border-radius: 4px;
}
.lang-btn-filter.active {
  background: #002244;
  color: white;
}

.notice-detail .content a {
  color: #0055aa;
  font-weight: 500;
  text-decoration: underline;
  word-break: break-all;
}

.admin-tabs-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(90deg, #002244, #004488);
  padding: 1rem 1.5rem;
  border-radius: 12px;
  margin-bottom: 2rem;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  flex-wrap: wrap;
}

.admin-tabs {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.admin-tab {
  color: white;
  font-weight: 600;
  padding: 0.6rem 1.4rem;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  text-decoration: none;
  transition: background 0.3s ease, transform 0.2s ease;
}

.admin-tab:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: translateY(-2px);
}

.admin-tab.active {
  background: white;
  color: #002244;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.logout-btn {
  padding: 0.6rem 1rem;
  background-color: white;
  color: #002244;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: background 0.3s ease;
  margin-top: 0.5rem;
}

.logout-btn:hover {
  background-color: #dde4ee;
}

.main-layout {
  display: flex;
  gap: 2rem;
  align-items: flex-start;
}

#notice-form {
  flex: 1.5;
  min-width: 400px;
}

.preview-panel {
  flex: 1;
  min-width: 300px;
}

#notice-list {
  max-height: 600px;
  overflow-y: auto;
}

    </style>
</head>

<body>
      
    <header class="admin-tabs-container">
              <div style="display: flex; align-items: center; gap: 2rem;">
    <a href="index.html">
      <img src="images/logo.png" alt="C&L Global ë¡œê³ " style="height: 40px;" />
    </a>
        <nav class="admin-tabs">
          <a href="admin.html" class="admin-tab">ê³µì§€ì‚¬í•­ ê´€ë¦¬</a>
          <a href="admin-newsletter.html" class="admin-tab">ë‰´ìŠ¤ë ˆí„° ê´€ë¦¬</a>
          <a href="admin-resources.html" class="admin-tab active">ìë£Œì‹¤ ê´€ë¦¬</a>
        </nav>
        <button class="logout-btn" id="logout-btn" style="margin-left: 1000px;">ë¡œê·¸ì•„ì›ƒ</button>
      </header>
      
      

      
      
  <h1>ìë£Œì‹¤ ê´€ë¦¬</h1>


  <div class="main-layout">  
    
    <div class="preview-panel">
  <div id="language-tabs" style="margin: 1rem 0; display: flex; gap: 1rem;">
    <button type="button" class="lang-btn-filter active" data-lang="ko">í•œêµ­ì–´</button>
    <button type="button" class="lang-btn-filter" data-lang="en">English</button>
    <button type="button" class="lang-btn-filter" data-lang="zh">ä¸­æ–‡</button>
  </div>
  

  <section id="notice-list"></section>
  <div id="pagination" style="text-align:center; margin: 2rem 0;"></div>
    </div>
  <form id="notice-form">
    <input type="hidden" id="notice-id">
  
    <div class="tabs">      
      <button type="button" class="tab-btn active" data-tab="ko">í•œêµ­ì–´</button>        
        <button type="button" class="tab-btn" data-tab="en">English</button>
      <button type="button" class="tab-btn" data-tab="zh">ä¸­æ–‡</button>
    </div>



    <div class="tab-content active" id="tab-ko">
      <input id="title-ko" name="title-ko" placeholder="ì œëª© (í•œê¸€)" />
      <textarea id="content-ko" placeholder="ë‚´ìš© (í•œê¸€)"></textarea>
    </div>

    <div class="tab-content" id="tab-en">
      <input id="title-en" name="title-en" placeholder="Title (English)" />
      <textarea id="content-en" placeholder="Content (English)"></textarea>
    </div>  
  
    <div class="tab-content" id="tab-zh">
      <input id="title-zh" name="title-zh" placeholder="æ ‡é¢˜ (ì¤‘êµ­ì–´)" />
      <textarea id="content-zh" placeholder="å†…å®¹ (ì¤‘êµ­ì–´)"></textarea>
    </div>

    <button type="button" onclick="insertHyperlink()" style="margin-top: 0.5rem; width: 150px;">ğŸ”— ë§í¬ ì‚½ì…</button>

  
    <input type="file" id="file-upload" multiple />
    <div id="preview" style="margin-top: 1rem;"></div>
  
    <button type="submit">ì €ì¥</button>
  </form>
  

</div>

  <script>
      const postsPerPage = 10;
const uploadInput = document.getElementById('file-upload');
const previewArea = document.getElementById('preview');
    const contentField = document.getElementById('content-ko');
    const uploadedImages = [];

  
    // ë¡œê·¸ì¸ ê²€ì‚¬
const token = sessionStorage.getItem('token');
if (!token) {
  alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  window.location.href = '/admin-login.html';
}

  
    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      localStorage.removeItem('token');
      alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      window.location.href = '/admin-login.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('logout-btn').addEventListener('click', () => {
sessionStorage.removeItem('token');

    alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    window.location.href = '/admin-login.html';
  });
});

  
    // ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadNotices(q = "") {
      const res = await fetch('/api/notices?q=' + encodeURIComponent(q));
      const data = await res.json();
      const notices = data.notices || [];         // âœ… ì¶”ê°€
      const list = document.getElementById('notice-list');
      list.innerHTML = "";
      const lang = localStorage.getItem('siteLanguage') || 'ko';

notices.forEach(notice => {
    const title = notice.title?.[lang] || notice.title?.en || notice.title?.ko || notice.title?.zh || '(ì œëª© ì—†ìŒ)';
const content = notice.content?.[lang] || notice.content?.en || notice.content?.ko || notice.title?.zh || '';

const titleEl = document.createElement("strong");
titleEl.textContent = title;

const timeEl = document.createElement("small");
timeEl.textContent = new Date(notice.createdAt).toLocaleString();

const contentEl = document.createElement("p");
contentEl.textContent = content;

const actionsDiv = document.createElement("div");
actionsDiv.className = "notice-actions";

const editBtn = document.createElement("button");
editBtn.textContent = "âœ ìˆ˜ì •";
editBtn.addEventListener("click", () => editNotice(notice));

const deleteBtn = document.createElement("button");
deleteBtn.textContent = "ğŸ—‘ ì‚­ì œ";
deleteBtn.addEventListener("click", () => deleteNotice(notice._id));

actionsDiv.appendChild(editBtn);
actionsDiv.appendChild(deleteBtn);

const div = document.createElement("div");
div.className = "notice";
div.appendChild(titleEl);
div.appendChild(timeEl);
div.appendChild(contentEl);
div.appendChild(actionsDiv);

list.appendChild(div);

});

    }
  
    const searchInput = document.getElementById('search');
if (searchInput) {
  searchInput.addEventListener('input', () => {
    const q = searchInput.value;
    loadNotices(q);
  });
}

  
    // ê¸€ ìˆ˜ì •
    function editNotice(notice) {
      document.getElementById('notice-id').value = notice._id;
      document.getElementById('title-ko').value = notice.title.ko;
      document.getElementById('title-en').value = notice.title.en;
      document.getElementById('title-zh').value = notice.title.zh;
      document.getElementById('content-ko').value = notice.content.ko;
      document.getElementById('content-en').value = notice.content.en;
      document.getElementById('content-zh').value = notice.content.zh;
    }
  
    // ê¸€ ì‚­ì œ
    async function deleteNotice(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await fetch(`/api/notices/${id}`, { method: 'DELETE' });
      loadNotices();
    }
  
  
  // Drag & Drop
  previewArea.ondragover = (e) => {
    e.preventDefault();
    previewArea.style.border = '2px dashed #004488';
  };
  previewArea.ondragleave = (e) => {
    e.preventDefault();
    previewArea.style.border = '';
  };
  previewArea.ondrop = (e) => {
    e.preventDefault();
    previewArea.style.border = '';
    uploadInput.files = e.dataTransfer.files;
    uploadInput.dispatchEvent(new Event('change'));
  };

  // ì´ë¯¸ì§€ ì—…ë¡œë“œ + ì‚­ì œ ë²„íŠ¼ + ë³¸ë¬¸ ì‚½ì…
  uploadInput.addEventListener('change', async (e) => {
  const files = Array.from(e.target.files);
  const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
  const textarea = document.getElementById(`content-${activeTab}`);

  for (const file of files) {
    const formData = new FormData();
    formData.append('image', file); // ì„œë²„ì—ì„  'image' í•„ë“œëª… ê·¸ëŒ€ë¡œ ì‚¬ìš© ì¤‘

    const res = await fetch('/api/notices/upload', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + sessionStorage.getItem('token')

      },
      body: formData
    });

    const data = await res.json();
    const fileUrl = data.url;
    const ext = file.name.split('.').pop().toLowerCase();

    let insertTag = '';
    if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
      insertTag = `<img src="${fileUrl}" alt="ì²¨ë¶€ ì´ë¯¸ì§€">\n`;
    } else {
      insertTag = `<a href="${fileUrl}" download>${file.name}</a>\n`;
    }

    textarea.value += `\n${insertTag}`; // ë³¸ë¬¸ì— ìë™ ì‚½ì…

    // ë¯¸ë¦¬ë³´ê¸° UIë„ êµ¬ì„± (ì„ íƒ)
    const wrapper = document.createElement('div');
    wrapper.style.marginBottom = '0.5rem';

    if (insertTag.includes('<img')) {
      const img = document.createElement('img');
      img.src = fileUrl;
      img.width = 100;
      img.style.borderRadius = '6px';
      img.style.boxShadow = '0 1px 4px rgba(0,0,0,0.1)';
      wrapper.appendChild(img);
    } else {
      const fileLink = document.createElement('a');
      fileLink.href = fileUrl;
      fileLink.textContent = file.name;
      fileLink.style.color = '#0055aa';
      fileLink.download = '';
      wrapper.appendChild(fileLink);
    }

    previewArea.appendChild(wrapper);
  }
});

  
    // í˜ì´ì§€ ë¡œë“œì‹œ ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸°
    loadNotices();

    // íƒ­ ì „í™˜
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');

        // ğŸ”¥ í•µì‹¬: ì„ íƒëœ ì–¸ì–´ë¡œ ê°±ì‹ 
        selectedLang = btn.dataset.tab;
    renderPostsFromServer(1); // ì–¸ì–´ ë°”ë€Œì—ˆìœ¼ë‹ˆ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë¡œë”©
  });
});

// ì €ì¥ì‹œ ì–¸ì–´ë³„ ë‚´ìš© ë¹„ì–´ìˆìœ¼ë©´ null ì²˜ë¦¬
document.getElementById('notice-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const id = document.getElementById('notice-id').value;
  const langs = ['ko', 'en', 'zh'];
  const title = {};
  const content = {};
  let hasAtLeastOne = false;

  langs.forEach(lang => {
    const t = document.getElementById(`title-${lang}`).value.trim();
    const c = document.getElementById(`content-${lang}`).value.trim();
    if (t || c) hasAtLeastOne = true;
    title[lang] = t || null;
    content[lang] = c || null;
  });

  if (!hasAtLeastOne) {
    alert("ìµœì†Œ í•œ ì–¸ì–´ ì´ìƒì˜ ì œëª© ë˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
    return;
  }

  const currentPath = window.location.pathname;
  let category = 'notice';
  if (currentPath.includes('resources')) {
    category = 'resource';
  } else if (currentPath.includes('newsletter')) {
    category = 'newsletter';
  }

  const payload = {
    title,
    content,
    category
  };

  const method = id ? 'PUT' : 'POST';
  const url = id ? `/api/notices/${id}` : '/api/notices';

  await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  document.getElementById('notice-form').reset();
  document.getElementById('notice-id').value = '';
  uploadInput.value = '';
  previewArea.innerHTML = '';
  renderPostsFromServer(1);
  alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
});




let selectedLang = 'ko'; // âœ… ì´ˆê¸°ê°’: í•œêµ­ì–´
document.addEventListener("DOMContentLoaded", () => {
  renderPostsFromServer(1); // âœ… ê¸°ë³¸ ê³µì§€ì‚¬í•­ ë¡œë”©
});


document.querySelectorAll('.lang-btn-filter').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.lang-btn-filter').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedLang = btn.dataset.lang;
    renderPostsFromServer(1); // ì–¸ì–´ ë³€ê²½ ì‹œ ë‹¤ì‹œ ë¡œë”©
  });
});

function renderPostsFromServer(page = 1, query = "") {
  fetch(`/api/notices?category=resource&page=${page}&q=${encodeURIComponent(query)}`)

    .then(res => res.json())
    .then(resData => {
  const allPosts = resData.notices || []; // âœ… ê³µì§€ ë°°ì—´ ì¶”ì¶œ
  const start = (page - 1) * postsPerPage;
  const sliced = allPosts.slice(start, start + postsPerPage); // âœ… ì´ì œ ì •ìƒ

      const listContainer = document.getElementById("notice-list");
      listContainer.innerHTML = "";

      sliced.forEach(post => {
        const title = post.title?.[selectedLang];
        const content = post.content?.[selectedLang];
        if (!title || !content) return;

        const div = document.createElement("div");
        div.className = "notice";
        div.innerHTML = `
          <strong>${title}</strong><br>
          <small>${new Date(post.createdAt).toLocaleString()}</small>
          <p>${content}</p>
          <div class="notice-actions">
            <button onclick='editNotice(${JSON.stringify(post)})'>âœ ìˆ˜ì •</button>
            <button onclick='deleteNotice("${post._id}")'>ğŸ—‘ ì‚­ì œ</button>
          </div>
        `;
        listContainer.appendChild(div);
      });

       renderPagination(allPosts.length, page);
    });
}

function insertImageToActiveContent(url) {
  // í˜„ì¬ í™œì„± íƒ­ ì°¾ê¸°
  const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
  const textarea = document.getElementById(`content-${activeTab}`);
  const imgTag = `<img src="${url}" alt="ì²¨ë¶€ ì´ë¯¸ì§€">\n`;

  textarea.value += `\n${imgTag}`; // ê¸°ì¡´ ë‚´ìš© ë’¤ì— ì´ë¯¸ì§€ ì‚½ì…
}

function renderPagination(totalPosts, currentPage) {
  const totalPages = Math.ceil(totalPosts / postsPerPage);
  const pagination = document.getElementById("pagination");

  if (!pagination) return;

  pagination.innerHTML = "";

  for (let i = 1; i <= totalPages; i++) {
    const button = document.createElement("button");
    button.textContent = i;
    if (i === currentPage) button.classList.add("active");
    button.addEventListener("click", () => renderPostsFromServer(i));
    pagination.appendChild(button);
  }
}

function switchLanguage(lang) {
  // ìƒë‹¨ íƒ­
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === lang);
  });
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.toggle('active', tab.id === `tab-${lang}`);
  });

  // í•˜ë‹¨ ëª©ë¡ íƒ­
  document.querySelectorAll('.lang-btn-filter').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.lang === lang);
  });

  selectedLang = lang;
  renderPostsFromServer(1);
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchLanguage(btn.dataset.tab));
});

document.querySelectorAll('.lang-btn-filter').forEach(btn => {
  btn.addEventListener('click', () => switchLanguage(btn.dataset.lang));
});


function insertHyperlink() {
  const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
  const textarea = document.getElementById(`content-${activeTab}`);

  const url = prompt("ë§í¬í•  ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: https://www.example.com)");
  if (!url) return;

  const text = prompt("ë§í¬ì— í‘œì‹œí•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", url);
  if (text === null) return;

  const linkTag = `<a href="${url}" target="_blank">${text}</a>`;
  textarea.value += `\n${linkTag}\n`;
}

  </script>
  
  


</body>
</html>
